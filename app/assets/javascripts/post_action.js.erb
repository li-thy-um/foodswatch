$(function(){
  init_watch_post();
  
  $('.btn-action').hover(function(){
    $(this).children("i").toggleClass("icon-white");
    $(this).children("span").toggleClass("badge-inverse");
  });

  $('.btn-add-food').popover({
    html: true,
    container: "body",
    placement: "bottom"
  }).click(init_add_food_popover);
});

function reset_watch_post($btn){
  _set_watch_post($btn);
}

function init_watch_post(){
  $('.btn-watch-post').each(function(i,e){
    var $btn = $(e);
    if (!$btn.hasClass('btn-submit')){
      _set_watch_post($btn);
    }
  });
}

function _set_watch_post($btn){
  $btn.popover({
    html: true,
    container: "body",
    placement: "left",
    content: function(){
      return $btn.prev().html(); 
    }
  }).click(init_watch_post_popover);
}

var init_watch_post_popover = function(){
  var $form = $(".popover").children(".popover-content").children("form");
  $form.children(".input-prepend").children(".name").
    keypress(toggle_watch_post_btn).
    keyup(toggle_watch_post_btn).
    keypress();
}

var init_add_food_popover = function(){
  $(".watch-list-typeahead").typeahead({
    source: function(query, process){
      process(get_watch_list());
    },
   
    highlighter: function(food_info){
      return make_food(food_info).name;
    },

    updater: function(food_info) {
      var food = make_food(food_info); //food_info is a string.
      add_hidden_input_by(food.id); //do this before add_label.
      add_label_by(food.name);
    }
  });

  $("#create_food_btn").click(add_food);

  var $form = $("#new_food_form");
  $form.children(".nutri").numeralinput();
  $form.children(".name").
    keypress(toggle_create_food_btn).
    keyup(toggle_create_food_btn).
    keypress();
}

function get_watch_list(){
  return $("#watch_list").val().split(",");  
}

function make_food(food_info /* like "id_name" */){
  var info_array = food_info.split("_");
  return {
    id: info_array[0],
    name: info_array[1]
  };
}

var toggle_watch_post_btn = function(){
  attach_toggle($(this).prev(), $(this));
}

var toggle_create_food_btn = function(){
  attach_toggle($("#create_food_btn"), $(this));
}

function attach_toggle($btn, $input){
  var str = $input.val() || "";
  if ($.trim(str) == ""){
    disable($btn);
  }else{
    enable($btn);
  }
}

var add_food = function() {
  add_hidden_input();
  add_label();
  clear($("#new_food_form"));
}

var delete_food = function() {
  var $label = $(this);
  var id = $label.attr("id");
  $("#food_form").children(".group_" + id).each(function(i,e){
    $(e).remove();
  });
  $label.remove();
}

function add_label_by(name){
  var $label = $("#label_sample").children().first().clone().html(name);
  $label.attr("id", count_food()).click(delete_food);
  $("#choosed").append($label);
}

function add_label() {
  var food_name = $("#new_food_form").children(".name").first().val();
  add_label_by(food_name);   
}

function append_input($form, $input, value){
  $input.attr("value", value);
  $input.addClass("group_" + count_food());
  $form.append($input); 
}

function add_hidden_input_by(id){  
  $food_form = $("#food_form");
  $input = $("#food_id_input_sample").children().first().clone();
  append_input($food_form, $input, id);
}

function add_hidden_input() {
 $food_sample = $("#new_food_form");
 $food_form = $("#food_form");

 $food_sample.children("input").each(function(i,e) {
   $input = $(e).clone();
   var value = $input.val();
   if (value == "") value = 0; //default value for nutri 
   append_input($food_form, $input, value);
 });
}

function count_food() {
  return $("#choosed").children(".label").length;
}
